---
name: tdd
description: Test-Driven Development workflow. Use this skill when implementing new features, fixing bugs, or refactoring code with TDD. Applies Red-Green-Refactor cycle with techniques like Fake It, Triangulation, and Obvious Implementation. Goal is "clean code that works" (動作するきれいなコード).
---

# テスト駆動開発 (TDD)

Red-Green-Refactorサイクルに基づくTDD開発ワークフロー。

## 目標

**「動作するきれいなコード」（Clean code that works）**

最初からきれいかつ動くコードを書くのは困難。TDDでは：
1. まず「動く」コードを作成（テストに通る）
2. 次にリファクタリングで「きれい」に整形

## 黄金の回転（Red-Green-Refactor）

```
┌─────────────────────────────────────────────────┐
│                                                 │
│    RED ──────────► GREEN ──────────► REFACTOR  │
│     │                                    │      │
│     └────────────────────────────────────┘      │
│                                                 │
└─────────────────────────────────────────────────┘
```

### 1. RED（レッド）- 失敗するテストを書く

- 実装したい機能の仕様をテストとして表現
- テストは必ず失敗することを確認（赤いバー）
- **重要**: 期待したエラーになっているか確認してから次へ進む

```
# 悪い例：テストを書いて即座に実装
# 良い例：テストを書く → 実行 → 失敗を確認 → 実装
```

### 2. GREEN（グリーン）- テストを通す最小限の実装

- テストが通る最小限のコードを書く
- この段階では「きれい」である必要はない
- 目的はテストを通すこと（緑のバー）

### 3. REFACTOR（リファクタリング）- コードをきれいにする

- テストが通る状態を維持しながら改善
- 重複を取り除く
- 可読性を向上させる
- **全てのテストを実行**して回帰がないことを確認

## 3つの実装テクニック

### 仮実装（Fake It）

実装に自信がないとき、最短でグリーンにする。

```python
# テスト
def test_add():
    assert add(1, 2) == 3

# 仮実装（ハードコード）
def add(a, b):
    return 3  # まずこれでグリーンにする
```

**効果**:
- 心理的効果：グリーンで自信を持って次へ進める
- スコープ制御：本質と関係ない問題に気を取られない
- テストのテスト：テストが正しく動くか確認できる

### 三角測量（Triangulation）

仮実装から本実装へ移行するため、テストケースを追加。

```python
# 1つ目のテスト
def test_add_1_2():
    assert add(1, 2) == 3

# 2つ目のテスト追加（三角測量）
def test_add_3_4():
    assert add(3, 4) == 7

# これで本実装が必要になる
def add(a, b):
    return a + b
```

**使用場面**:
- 実装方法が明らかでないとき
- 設計のアイデアが浮かばないとき
- 歩幅を狭めて確認しながら進みたいとき

### 明白な実装（Obvious Implementation）

実装方法が明らかなとき、直接実装。

```python
# テスト
def test_add():
    assert add(1, 2) == 3

# 明白な実装（自信があるとき）
def add(a, b):
    return a + b
```

## 歩幅の調整

状況に応じて歩幅（実装の粒度）を調整：

| 状況 | 歩幅 | テクニック |
|------|------|-----------|
| 自信がない・不安 | 小さく | 仮実装 → 三角測量 |
| 実装が明白 | 大きく | 明白な実装 |
| テスト失敗で混乱 | 小さく戻る | 仮実装に戻る |

**原則**: 失敗したら歩幅を小さくする

## TDD実践フロー

```
1. TODOリストを作成
   - 実装すべき機能をリストアップ
   - 最も簡単なものから始める

2. テストを1つ選ぶ
   - TODOリストから1つ選択
   - 小さく始める

3. RED: テストを書く
   - 失敗するテストを書く
   - 実行して失敗を確認

4. GREEN: 実装する
   - 仮実装 or 明白な実装
   - テストが通ることを確認

5. REFACTOR: リファクタリング
   - 重複を除去
   - 全テスト実行

6. 繰り返し
   - TODOリストを更新
   - 次のテストへ
```

## 重要な原則

### テストは仕様である

- テストコードは実行可能な仕様書
- テスト名は「何をテストしているか」を明確に

### 小さなステップで進む

- 一度に大きな変更をしない
- 問題が起きたら原因を特定しやすい

### 全てのテストを毎回実行

- コード変更のたびに全テスト実行
- 過去のテストはセーフティネット

### リファクタリングは安全網の中で

- テストがあるからこそ安心してリファクタリングできる
- 「いじれないコード」を生まない

## アンチパターン

避けるべき行動：

1. **テストなしで実装を始める**
2. **失敗を確認せずに次へ進む**
3. **一度に大きな実装をする**
4. **リファクタリングをスキップする**
5. **テストが通らない状態で長時間作業する**

## コマンド例

```bash
# Python (pytest)
pytest -v                    # 全テスト実行
pytest -v test_file.py::test_name  # 単一テスト

# JavaScript (Jest)
npm test                     # 全テスト実行
npm test -- --watch          # ウォッチモード

# Go
go test -v ./...             # 全テスト実行
go test -v -run TestName     # 単一テスト
```
